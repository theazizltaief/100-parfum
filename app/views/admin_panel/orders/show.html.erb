<% content_for :page_title, "Commande ##{@order.id}" %>

<div class="admin-order-detail-container" data-controller="admin-orders">
  <div class="admin-order-detail-header">
    <div class="admin-order-detail-title">
      <h2>Commande #<%= @order.id %></h2>
      <span class="admin-status-badge admin-status-<%= @order.status_name %>">
        <%= case @order.status_name
            when 'pending' then 'En attente'
            when 'confirmed' then 'Confirmée'
            when 'shipped' then 'Expédiée'
            when 'delivered' then 'Livrée'
            when 'cancelled' then 'Annulée'
            else @order.status_name.capitalize
            end %>
      </span>
    </div>
    <div class="admin-order-detail-date">
      Passée le <%= @order.created_at.strftime("%d/%m/%Y à %H:%M") %>
    </div>
  </div>

  <div class="admin-order-detail-content">
    <div class="admin-order-section">
      <h3 class="admin-section-title">Informations client</h3>
      <div class="admin-order-info-grid">
        <div class="admin-info-item">
          <label>Nom complet</label>
          <span><%= @order.full_name || 'Non spécifié' %></span>
        </div>
        <div class="admin-info-item">
          <label>Téléphone</label>
          <span><%= @order.phone || 'Non spécifié' %></span>
        </div>
        <div class="admin-info-item">
          <label>Ville</label>
          <span><%= @order.city || 'Non spécifié' %></span>
        </div>
        <div class="admin-info-item">
          <label>Code postal</label>
          <span><%= @order.postal_code || 'Non spécifié' %></span>
        </div>
        <div class="admin-info-item admin-info-full">
          <label>Adresse de livraison</label>
          <span><%= @order.address || 'Non spécifié' %></span>
        </div>
        <% if @order.notes.present? %>
          <div class="admin-info-item admin-info-full">
            <label>Notes</label>
            <span><%= @order.notes %></span>
          </div>
        <% end %>
      </div>
    </div>

    <div class="admin-order-section">
      <h3 class="admin-section-title">Articles commandés</h3>
      <div class="admin-order-items">
        <% if @order.items.empty? %>
          <p class="no-items-message">Aucun article dans cette commande.</p>
        <% else %>
          <% @order.items.each do |item| %>
            <% 
              image_url = item['image_url'] || 'https://via.placeholder.com/250x250?text=Parfum'
              name = item['name'] || 'Produit inconnu'
              size = item['size'] || 'N/A'
              quantity = item['quantity']&.to_i || 1
              price = item['price']&.to_f || 0
              category = item['category'] ? (item['category'] == 'unisexe' ? 'Unisexe' : item['category'].capitalize) : 'Non spécifié'
              fragrance_class = item['fragrance_class'] ? (item['fragrance_class'] == 'collection_privee' ? 'Collection Privée' : item['fragrance_class'].capitalize) : 'Non spécifié'
            %>
            <div class="admin-order-item">
              <img src="<%= image_url %>" alt="<%= name %>" class="admin-item-image">
              <div class="admin-item-info">
                <h4 class="admin-item-name"><%= name %></h4>
                <p class="admin-item-details">
                  <%= size %> × <%= quantity %>
                  <br>
                  <span class="admin-item-meta">(<%= category %>, <%= fragrance_class %>)</span>
                </p>
              </div>
              <div class="admin-item-total">
                <%= number_to_currency(price * quantity, unit: 'TND ', separator: ',', delimiter: ' ', precision: 2) %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="admin-order-section">
      <h3 class="admin-section-title">Résumé financier</h3>
      <div class="admin-order-totals">
        <div class="admin-total-line">
          <span>Sous-total</span>
          <span><%= number_to_currency(@order.subtotal, unit: 'TND ', separator: ',', delimiter: ' ', precision: 2) %></span>
        </div>
        <div class="admin-total-line">
          <span>Frais de livraison</span>
          <span><%= number_to_currency(@order.delivery_fee, unit: 'TND ', separator: ',', delimiter: ' ', precision: 2) %></span>
        </div>
        <div class="admin-total-line admin-total-final">
          <span>Total</span>
          <span><%= number_to_currency(@order.total, unit: 'TND ', separator: ',', delimiter: ' ', precision: 2) %></span>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-order-detail-actions">
    <%= link_to admin_panel_orders_path, class: "admin-btn admin-btn-secondary" do %>
      <i class="fas fa-arrow-left"></i> Retour à la liste
    <% end %>
    
    <div class="admin-status-actions">
      <% unless @order.confirmed? %>
        <%= link_to update_status_admin_panel_order_path(@order, new_status: 'confirmed'), 
            method: :patch,
            class: "admin-btn admin-btn-success",
            data: { 
              action: "click->admin-orders#confirmDetailStatusChange",
              order_id: @order.id
            } do %>
          <i class="fas fa-check"></i> Confirmer
        <% end %>
      <% end %>
      
      <% if @order.confirmed? && !@order.shipped? %>
        <%= link_to update_status_admin_panel_order_path(@order, new_status: 'shipped'), 
            method: :patch,
            class: "admin-btn admin-btn-info",
            data: { 
              action: "click->admin-orders#confirmDetailStatusChange",
              order_id: @order.id
            } do %>
          <i class="fas fa-truck"></i> Marquer comme expédiée
        <% end %>
      <% end %>
      
      <% if @order.shipped? && !@order.delivered? %>
        <%= link_to update_status_admin_panel_order_path(@order, new_status: 'delivered'), 
            method: :patch,
            class: "admin-btn admin-btn-primary",
            data: { 
              action: "click->admin-orders#confirmDetailStatusChange",
              order_id: @order.id
            } do %>
          <i class="fas fa-check-circle"></i> Marquer comme livrée
        <% end %>
      <% end %>
      
      <% unless @order.cancelled? %>
        <%= link_to update_status_admin_panel_order_path(@order, new_status: 'cancelled'), 
            method: :patch,
            class: "admin-btn admin-btn-danger",
            data: { 
              action: "click->admin-orders#confirmDetailStatusChange",
              order_id: @order.id
            } do %>
          <i class="fas fa-times"></i> Annuler
        <% end %>
      <% end %>
    </div>
  </div>
</div>